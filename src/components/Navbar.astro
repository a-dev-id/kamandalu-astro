---
import OptimizedImage from '../components/OptimizedImage.astro';
---
<header id="navbar" class="fixed w-full z-50 transition-all duration-300 bg-transparent text-white overflow-visible">
  <!-- Top Section: Language Selector & Logo -->
  <div class="flex justify-between items-top px-6 py-1">
    <!-- Language Dropdown -->
    <div>
      <select id="languageSelect" class="bg-transparent text-white focus:outline-none text-sm">
        <option value="en" class="text-black">English</option>
        <option value="ko" class="text-black">한국어</option>
        <option value="zh" class="text-black">中文</option>
      </select>
    </div>
    <!-- Logo -->
    <div>
      <img
        id="navbar-logo"
        src="/images/kamandalu-logo.png"
        alt="Kamandalu Logo"
        class="w-36 h-20 transition-all duration-300 mt-2 logo brightness-0 invert-[1]"
         fetchpriority="high"
  loading="eager"
      />
    </div>
    <div class="w-10"></div>
  </div>

  <!-- Bottom Section: Main Navigation & Reserve Button -->
  <div class="flex justify-between items-center px-6 py-3 border-b border-white/50">
    <!-- Hamburger for Mobile -->
    <button id="hamburger">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>

    <!-- Desktop Navigation Menu -->
    <nav class="hidden md:flex space-x-6 text-base font-normal w-full justify-center overflow-visible relative">
      <a href="#" class="uppercase">Offers</a>
      <a href="#" class="uppercase">Villas</a>
      <a href="#" class="uppercase">Wellness</a>
      <!-- Dining Dropdown Trigger -->
      <div id="dining-trigger" class="relative group">
        <a href="#" class="inline-block px-2 uppercase">Dining</a>
      </div>
      <a href="#" class="uppercase">Unique Experiences</a>
      <a href="#" class="uppercase">Wedding & Events</a>
      <a href="#" class="uppercase">Activities</a>
      <a href="#" class="uppercase">Our Story</a>
      <!-- More Dropdown Trigger -->
      <div id="more-trigger" class="relative group">
        <a href="#" class="inline-block px-2 uppercase">More</a>
      </div>
    </nav>

    <!-- Reserve Button -->
    <a
      href="https://www.book-secure.com/index.php?s=results&property=idbal31692&locale=en_GB&currency=IDR&stid=986w12cwy"
      id="reserveBtn"
      class="bg-white text-black px-4 py-2 md:px-6 md:py-3 text-xs md:text-sm font-title tracking-widest transition-colors duration-300 border border-white whitespace-nowrap"
    >
      <span class="hidden sm:inline">RESERVE</span>
      <span class="inline sm:hidden">RESERVE</span>
    </a>
  </div>

  <!-- Off-Canvas Mobile Menu -->
  <div
    id="offcanvas"
    class="fixed top-0 left-0 h-full w-64 bg-white text-black shadow-lg transform -translate-x-full transition-transform duration-300 z-40 flex flex-col"
  >
    <!-- Offcanvas Close Button -->
    <div class="flex justify-end p-4">
      <button id="closeOffcanvas" aria-label="Close menu">
        <svg class="w-6 h-6 text-black hover:scale-110 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <!-- Offcanvas Navigation Links -->
    <nav class="flex-1 px-6 pb-6 space-y-4 overflow-y-auto font-normal">
      <a href="#" class="block text-xl">Offers</a>
      <a href="#" class="block text-xl">Villas</a>
      <a href="#" class="block text-xl">Wellness</a>
      <!-- Dining Dropdown (Mobile) -->
      <div>
        <button id="dining-mobile-toggle" class="block text-xl w-full text-left flex items-center gap-1 justify-between">
          <span class="flex items-center">
            Dining
            <svg class="w-4 h-4 ml-1 inline-block" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </span>
        </button>
        <div id="dining-mobile-dropdown" class="pl-4 space-y-2 hidden mt-3">
          <a href="#" class="block text-xl">Petulu</a>
          <a href="#" class="block text-xl">Aira</a>
          <a href="#" class="block text-xl">Awana</a>
          <a href="#" class="block text-xl">Vana Dining</a>
        </div>
      </div>
      <a href="#" class="block text-xl">Unique Experiences</a>
      <a href="#" class="block text-xl">Wedding & Events</a>
      <a href="#" class="block text-xl">Activities</a>
      <a href="#" class="block text-xl">Our Story</a>
      <!-- More Dropdown (Mobile) -->
      <div>
        <button id="more-mobile-toggle" class="block text-xl w-full text-left flex items-center gap-1 justify-between">
          <span class="flex items-center">
            More
            <svg class="w-4 h-4 ml-1 inline-block" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </span>
        </button>
        <div id="more-mobile-dropdown" class="pl-4 space-y-2 hidden mt-3">
          <a href="#" class="block text-xl">Member</a>
          <a href="#" class="block text-xl">Contact</a>
        </div>
      </div>
    </nav>
  </div>

  <!-- Desktop Dining Dropdown -->
  <div
    id="dining-dropdown"
    class="hidden absolute left-0 right-0 top-[100%] bg-white text-black z-40 shadow-md transition-all duration-200 opacity-0 group-hover:opacity-100"
  >
    <div class="max-w-screen-xl mx-auto px-2 flex justify-center space-x-6 py-3 font-normal text-xl">
      <a href="#" class="hover:underline uppercase text-base">Petulu</a>
      <a href="#" class="hover:underline uppercase text-base">Aira</a>
      <a href="#" class="hover:underline uppercase text-base">Awana</a>
      <a href="#" class="hover:underline uppercase text-base">Vana Dining</a>
    </div>
  </div>

  <!-- Desktop More Dropdown -->
  <div
    id="more-dropdown"
    class="hidden absolute left-0 right-0 top-[100%] bg-white text-black z-40 shadow-md transition-all duration-200 opacity-0 group-hover:opacity-100"
  >
    <div class="max-w-screen-xl mx-auto px-2 flex justify-center space-x-6 py-3 font-normal text-xl">
      <a href="#" class="hover:underline uppercase text-base">Member</a>
      <a href="#" class="hover:underline uppercase text-base">Contact</a>
    </div>
  </div>

  <!-- Navbar Script: Handles dropdowns, offcanvas, scroll, and language switch -->
  <script is:inline>
    // Helper: Update dropdown position below navbar
    function updateDropdownPosition(element, dropdown) {
      const navRect = element.getBoundingClientRect();
      dropdown.style.top = navRect.bottom + 'px';
    }

    // Elements
    const dropdown = document.querySelector('#dining-dropdown');
    const trigger = document.querySelector('#dining-trigger');
    const moreDropdown = document.querySelector('#more-dropdown');
    const moreTrigger = document.querySelector('#more-trigger');
    const navbar = document.querySelector('#navbar');

    // Change navbar style on scroll (background, text, logo, reserve button)
    window.addEventListener('scroll', () => {
      const languageSelect = document.querySelector("#languageSelect");
      const reserveBtn = document.querySelector("#reserveBtn");
      const logo = document.querySelector("#navbar-logo");

      if (window.scrollY > 50) {
        navbar.classList.add("bg-white", "text-black", "shadow-md");
        navbar.classList.remove("bg-transparent", "text-white");
        languageSelect.classList.remove("text-white");
        languageSelect.classList.add("text-black");
        reserveBtn.classList.remove("bg-white", "text-black", "border-white");
        reserveBtn.classList.add("bg-[#916B2C]", "text-white", "border-transparent");
        logo.classList.remove("h-20", "w-36", "brightness-0", "invert-[1]");
        logo.classList.add("w-16", "h-10");
      } else {
        navbar.classList.remove("bg-white", "text-black", "shadow-md");
        navbar.classList.add("bg-transparent", "text-white");
        languageSelect.classList.remove("text-black");
        languageSelect.classList.add("text-white");
        reserveBtn.classList.remove("bg-[#916B2C]", "text-white", "border-transparent");
        reserveBtn.classList.add("bg-white", "text-black", "border-white");
        logo.classList.remove("h-10", "w-16");
        logo.classList.add("h-20", "w-36", "brightness-0", "invert-[1]");
      }

      // Keep dropdowns positioned correctly on scroll
      if (!dropdown.classList.contains("hidden")) updateDropdownPosition(navbar, dropdown);
      if (!moreDropdown.classList.contains("hidden")) updateDropdownPosition(navbar, moreDropdown);
    });

    document.addEventListener("DOMContentLoaded", () => {
      // Offcanvas elements
      const hamburger = document.getElementById("hamburger");
      const offcanvas = document.getElementById("offcanvas");
      const closeBtn = document.getElementById("closeOffcanvas");

      // Mobile dropdowns
      const diningMobileToggle = document.getElementById("dining-mobile-toggle");
      const diningMobileDropdown = document.getElementById("dining-mobile-dropdown");
      const moreMobileToggle = document.getElementById("more-mobile-toggle");
      const moreMobileDropdown = document.getElementById("more-mobile-dropdown");

      // Desktop: Show/hide Dining dropdown on hover
      trigger.addEventListener("mouseenter", () => {
        updateDropdownPosition(navbar, dropdown);
        dropdown.classList.remove("hidden", "opacity-0");
        dropdown.classList.add("opacity-100", "block");
      });
      trigger.addEventListener("mouseleave", () => {
        setTimeout(() => {
          if (!dropdown.matches(":hover")) {
            dropdown.classList.add("opacity-0");
            dropdown.classList.remove("opacity-100");
            dropdown.classList.add("hidden");
          }
        }, 100);
      });
      dropdown.addEventListener("mouseenter", () => {
        dropdown.classList.remove("hidden", "opacity-0");
        dropdown.classList.add("opacity-100");
      });
      dropdown.addEventListener("mouseleave", () => {
        dropdown.classList.add("opacity-0");
        dropdown.classList.remove("opacity-100");
        dropdown.classList.add("hidden");
      });

      // Desktop: Show/hide More dropdown on hover
      moreTrigger.addEventListener("mouseenter", () => {
        updateDropdownPosition(navbar, moreDropdown);
        moreDropdown.classList.remove("hidden", "opacity-0");
        moreDropdown.classList.add("opacity-100", "block");
      });
      moreTrigger.addEventListener("mouseleave", () => {
        setTimeout(() => {
          if (!moreDropdown.matches(":hover")) {
            moreDropdown.classList.add("opacity-0");
            moreDropdown.classList.remove("opacity-100");
            moreDropdown.classList.add("hidden");
          }
        }, 100);
      });
      moreDropdown.addEventListener("mouseenter", () => {
        moreDropdown.classList.remove("hidden", "opacity-0");
        moreDropdown.classList.add("opacity-100");
      });
      moreDropdown.addEventListener("mouseleave", () => {
        moreDropdown.classList.add("opacity-0");
        moreDropdown.classList.remove("opacity-100");
        moreDropdown.classList.add("hidden");
      });

      // Offcanvas open/close
      hamburger.addEventListener("click", () => {
        offcanvas.classList.toggle("-translate-x-full");
      });
      closeBtn.addEventListener("click", () => {
        offcanvas.classList.add("-translate-x-full");
      });

      // Toggle mobile dropdowns in offcanvas
      diningMobileToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        diningMobileDropdown.classList.toggle("hidden");
      });
      moreMobileToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        moreMobileDropdown.classList.toggle("hidden");
      });

      // Close offcanvas when clicking any link/button except dropdown toggles/links
      const offcanvasItems = offcanvas.querySelectorAll("a, button");
      offcanvasItems.forEach((item) => {
        item.addEventListener("click", (e) => {
          if (
            e.target.closest("#dining-mobile-toggle") ||
            e.target.closest("#more-mobile-toggle") ||
            e.target.closest("#dining-mobile-dropdown") ||
            e.target.closest("#more-mobile-dropdown")
          ) {
            e.stopPropagation();
            return;
          }
          offcanvas.classList.add("-translate-x-full");
        });
      });
    });

    // Close offcanvas if clicking outside of it
    document.addEventListener("click", (e) => {
      const offcanvas = document.getElementById("offcanvas");
      const hamburger = document.getElementById("hamburger");
      const isClickInside = offcanvas.contains(e.target) || hamburger.contains(e.target);
      if (!isClickInside && !offcanvas.classList.contains("-translate-x-full")) {
        offcanvas.classList.add("-translate-x-full");
      }
    });

    // Language selector: change language prefix in URL
    const select = document.getElementById('languageSelect');
    const currentPath = window.location.pathname;
    const pathParts = currentPath.split('/');
    const currentLang = pathParts[1]; // Detect current language in URL

    // Set dropdown value based on current language
    select.value = ['en', 'ko', 'zh'].includes(currentLang) ? currentLang : 'en';

    select.addEventListener('change', (e) => {
      const selectedLang = e.target.value;
      const newPath = currentPath.replace(/^\/(en|ko|zh)/, `/${selectedLang}`);
      // If no language prefix, prepend it
      const finalPath = ['en', 'ko', 'zh'].includes(currentLang)
        ? newPath
        : `/${selectedLang}${currentPath}`;
      window.location.href = finalPath;
    });
  </script>
</header>

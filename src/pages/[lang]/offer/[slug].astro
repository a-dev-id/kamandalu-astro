---
import Layout from '../../../layouts/Base.astro';
import client from '../../../lib/sanityClient';
import { getLocale } from '../../../utils/getLocale';
import OptimizedImage from '../../../components/OptimizedImage.astro';
import { toHTML } from '@portabletext/to-html';

// Helper to format date strings for display
const formatDate = dateStr => new Date(dateStr).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

// Generate static paths for all offers in all supported languages
export async function getStaticPaths() {
  const slugs = await client.fetch(`*[_type == "offer" && defined(slug.current)]{ "slug": slug.current }`);
  const languages = ['en', 'ko', 'zh'];
  return languages.flatMap(lang => slugs.map(offer => ({ params: { lang, slug: offer.slug } })));
}

// Get parameters and locale from Astro
const { lang, slug } = Astro.params;
const locale = getLocale(lang);
const safeArray = arr => Array.isArray(arr) ? arr : [];

// Fetch offer data from Sanity CMS for the current slug and locale
const offer = await client.fetch(`*[_type == "offer" && slug.current == $slug][0]{
  title,
  excerpt,
  description,
  offerStart,
  offerEnd,
  mainImage { asset->{url} },
  mainImageAlt,
  minNights,
  promoCode,
  metaTitle,
  metaDescription,
  metaKeywords,
  order,
  "inclusion": inclusion[$locale],
  "cancelPolicy": cancelPolicy[$locale],
}`, { slug, locale });

// Convert inclusion and cancel policy fields to HTML using Portable Text
const htmlListComponents = {
  list: ({ children, value }) =>
    value?.listItem === 'bullet' || value?.style === 'normal'
      ? `<ul class="list-disc ml-6 space-y-2">${children}</ul>`
      : `<ol class="list-decimal ml-6 space-y-2">${children}</ol>`,
  listItem: ({ children }) => `<li>${children}</li>`,
};

const inclusionHTML = toHTML(safeArray(offer.inclusion), {
  components: htmlListComponents,
});

const cancelPolicyHTML = toHTML(safeArray(offer.cancelPolicy), {
  components: htmlListComponents,
});

// Prepare meta and description fields for SEO and display
const offerDescription = toHTML(safeArray(offer.description?.[locale]));
const title = offer?.metaTitle?.[locale] ?? '';
const description = offer?.metaDescription?.[locale] ?? '';
const baseUrl = new URL(Astro.request.url);
const url = baseUrl.href;
const ogImage = offer.mainImage?.asset?.url ?? '';
const keywords = offer.metaKeywords?.[locale] ?? '';
---

<Layout {title} {description} {url} {ogImage} {keywords}>
  {/* Hero section with main offer image */}
  <section class="relative w-full h-[50vh] md:h-[60vh] lg:h-[75vh] overflow-hidden">
    <OptimizedImage
      src={offer.mainImage.asset.url}
      alt={offer.mainImageAlt?.[locale] ?? ''}
      width={1600}
      height={900}
      quality={75}
      className="w-full h-full object-cover"
    />
    <div class="absolute inset-0 bg-black/25 z-20"></div>
  </section>

  {/* Offer title and description */}
  <section class="container mx-auto px-4 xl:px-10 2xl:px-0 py-16 md:py-24">
    <div class="text-center px-2 sm:px-6 md:px-8 mx-auto">
      <h1 class="font-title text-3xl sm:text-4xl md:text-5xl uppercase mb-4 md:mb-6 tracking-widest font-light">
        {offer?.title?.[locale] ?? ''}
      </h1>
      <div class="text-lg prose max-w-none" set:html={offerDescription}></div>
    </div>
  </section>

  {/* What's Included and Booking section */}
  <section class="container mx-auto px-4 xl:px-10 2xl:px-0 pb-16 md:pb-24">
    <div class="flex flex-col lg:flex-row justify-between gap-12">
      {/* Inclusion list */}
      <div class="lg:w-4/5">
        <h3 class="font-title text-xl md:text-2xl uppercase mb-6">What's Included</h3>
        <div class="text-lg max-w-none" set:html={inclusionHTML}></div>
      </div>
      {/* Offer validity and booking button */}
      <div class="lg:w-1/5 flex flex-col items-end">
        <div>
          <!-- <h3 class="font-title text-xl md:text-2xl uppercase mb-2">Offer Valid</h3>
          <p class="text-lg mb-6">
            {offer.offerStart ? formatDate(offer.offerStart) : ''} - {offer.offerEnd ? formatDate(offer.offerEnd) : ''}
          </p> -->
          <h3 class="font-title text-xl md:text-2xl uppercase mb-2">Reserve the special offers</h3>
          <p class="text-lg mb-6">
            Tel: +62 361 975825
          </p>
          <a
            href={`https://www.book-secure.com/index.php?s=results&property=idbal31692&locale=${locale}_GB&stid=986w12cwy`}
            class="inline-block px-4 py-3 md:px-4 md:py-2 text-xs font-title tracking-widest border bg-[#916B2C] text-white border-transparent hover:bg-white hover:text-black hover:border-black transition-colors duration-300 text-center"
            target="_blank"
            rel="noopener noreferrer"
          >
            BOOK NOW
          </a>
        </div>
      </div>
    </div>
  </section>

  {/* Accordion for cancellation policy */}
  <section class="container mx-auto px-4 xl:px-10 2xl:px-0 pb-12">
    <div class="border-t border-b border-gray-300">
      <button
        type="button"
        class="w-full flex justify-between items-center py-4 font-title text-left text-lg uppercase toggle-btn"
        data-target="accordion-1"
        aria-expanded="false"
        aria-controls="accordion-1"
      >
        Terms & Conditions
        {/* SVG icon for accordion toggle */}
        <svg class="w-5 h-5 transition-transform duration-300" data-icon data-target="accordion-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div id="accordion-1" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6 hidden" role="region" aria-labelledby="accordion-1">
        <div class="text-lg max-w-none" set:html={cancelPolicyHTML}></div>
      </div>
    </div>
  </section>

  {/* Inline script for accordion toggle functionality */}
  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.dataset.target;
          const panel = document.getElementById(targetId);
          const icon = document.querySelector(`svg[data-icon][data-target="${targetId}"]`);
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          btn.setAttribute('aria-expanded', String(!expanded));
          panel.classList.toggle('hidden');
          icon.classList.toggle('rotate-180');
        });
      });
    });
  </script>
</Layout>

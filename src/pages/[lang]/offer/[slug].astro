---
import Layout from '../../../layouts/Base.astro';
import client from '../../../lib/sanityClient';
import { getLocale } from '../../../utils/getLocale';
import OptimizedImage from '../../../components/OptimizedImage.astro';
import { toHTML } from '@portabletext/to-html';

// Generate all static paths for offers and languages
export async function getStaticPaths() {
  const slugs = await client.fetch(`*[_type == "offer" && defined(slug.current)]{ "slug": slug.current }`);
  const languages = ['en', 'ko', 'zh'];
  return languages.flatMap(lang =>
    slugs.map(offer => ({
      params: { lang, slug: offer.slug }
    }))
  );
}

// Get route params and locale
const { lang, slug } = Astro.params;
const locale = getLocale(lang);

// Helper to safely handle Portable Text arrays
const safeArray = (arr) => Array.isArray(arr) ? arr : [];

// Fetch offer detail from Sanity
const offer = await client.fetch(`*[_type == "offer" && slug.current == $slug][0]{
  title,
  excerpt,
  description,
  mainImage { asset->{url} },
  mainImageAlt,
  minNights,
  promoCode,
  metaTitle,
  metaDescription,
  metaKeywords,
  order,
}`, { slug });

// Convert Portable Text to HTML strings safely with fallback
const htmlFields = {
  description: toHTML(safeArray(offer?.description?.[locale])),
};

const title = offer?.title?.[locale] ?? '';
const description = offer?.excerpt?.[locale] ?? '';
---

<Layout {title} {description}>
<!-- Hero Section -->
<section class="relative w-full h-[50vh] md:h-[60vh] lg:h-[75vh] overflow-hidden">
  <OptimizedImage
    src={offer.mainImage.asset.url}
    alt={offer.mainImageAlt?.[locale] ?? ''}
    width={1600}
    height={900}
    quality={75}
    className="w-full h-full object-cover"
  />
  <div class="absolute inset-0 bg-black/25 z-20"></div>
</section>

<!-- Page Title & Description -->
<section class="container mx-auto px-4 xl:px-10 2xl:px-0 py-16 md:py-24">
  <div class="text-center px-2 sm:px-6 md:px-8 mx-auto">
    <h1 class="font-title text-3xl sm:text-4xl md:text-5xl uppercase mb-4 md:mb-6 tracking-widest font-light">
      {title}
    </h1>
    <p class="text-base md:text-lg">
      {offer?.description?.[locale] ?? ''}
    </p>
  </div>
</section>

  <!-- OFFERS CAROUSEL -->
  <section class="container mx-auto px-4 xl:px-10 2xl:px-0 pt-24">
    <div  class="splide mb-8 md:mb-12">
            <div class="bg-white overflow-hidden flex flex-col h-full">
              <OptimizedImage src={offer.mainImage.asset.url} alt={offer.mainImageAlt?.[locale]} width={800} height={600} quality={75} loading="lazy" className="w-full h-auto aspect-[4/3] transition duration-500" />
              <div class="p-4 md:p-6 flex flex-col flex-1">
                <h3 class="text-base md:text-lg tracking-widest uppercase font-title">{offer.title?.[locale] ?? offer.title?.en}</h3>
                <p class="mt-2 text-sm md:text-base">{offer.excerpt?.[locale] ?? offer.excerpt?.en}</p>
                <div class="flex-grow"></div>
                <a href={`/${locale}/offers/${offer.slug}`} class="text-base md:text-lg mt-4 inline-block text-black uppercase">{translations.btnexplore[locale]}</a>
              </div>
            </div>
        
    </div>
    
  </section>

 
</Layout>

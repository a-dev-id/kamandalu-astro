---
// Import necessary components and utilities
import Layout from '../../layouts/Base.astro';
import client from '../../lib/sanityClient';
import { getLocale } from '../../utils/getLocale';
import OptimizedImage from '../../components/OptimizedImage.astro';
import { toHTML } from '@portabletext/to-html';

// Generate static paths for supported languages
export async function getStaticPaths() {
  return ['en', 'ko', 'zh'].map(lang => ({ params: { lang } }));
}

// Get language parameter and locale
const { lang } = Astro.params;
const locale = getLocale(lang);

// Helper to ensure array safety
const safeArray = arr => Array.isArray(arr) ? arr : [];

// Fetch page details from Sanity CMS
const pageDetails = await client.fetch(`*[_type == "page" && _id == "27d587b8-e5a7-479f-b7b4-94d3be0b6aa3"][0]{
  title, subtitle, description, metaTitle, metaDescription, metaKeywords,
  mainImageAlt, mainImage { asset->{url} }
}`);

// Fetch gallery data from Sanity
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

const rawGallery = await client.fetch(`*[_type == "gallery"]{
  image { asset->{url} },
  imageAlt,
  category
}`);

const galleryItems = shuffleArray(rawGallery);


// Prepare content and meta data for the page
const pageDescription = toHTML(safeArray(pageDetails.description?.[locale]));
const title = pageDetails?.metaTitle?.[locale] ?? '';
const description = pageDetails?.metaDescription?.[locale] ?? '';
const url = new URL(Astro.request.url).href;
const ogImage = pageDetails.mainImage?.asset?.url ?? '';
const keywords = pageDetails.metaKeywords?.[locale] ?? '';
---

<Layout {title} {description} {url} {ogImage} {keywords}>
  {/* Hero section with background image */}
  <section class="relative w-full h-[50vh] md:h-[60vh] lg:h-[75vh] overflow-hidden">
    <OptimizedImage
      src={pageDetails.mainImage.asset.url}
      alt={pageDetails.mainImageAlt?.[locale] ?? ''}
      width={1600} height={900} quality={75}
      className="w-full h-full object-cover"
    />
    <div class="absolute inset-0 bg-black/25 z-20"></div>
  </section>

  {/* Main content section with title, description, and YouTube video */}
  <section class="container mx-auto px-4 xl:px-10 2xl:px-56 pt-16 md:pt-24">
    <div class="text-center px-2 sm:px-6 md:px-8 mx-auto">
      <h1 class="font-title text-3xl sm:text-4xl md:text-5xl uppercase mb-4 md:mb-6 tracking-widest font-light">
        {pageDetails?.title?.[locale] ?? ''}
      </h1>
      <div class="mb-12 md:mb-18 text-lg" set:html={pageDescription}></div>
    </div>
  </section>

<section class="container mx-auto px-4 py-24">
  <!-- Filter Buttons -->
  <div class="text-center mb-10 flex flex-wrap justify-center gap-2">
    <button data-filter="all" class="filter-btn bg-white text-black px-4 py-2 text-xs font-title tracking-widest transition-colors duration-300 border border-black hover:bg-[#916B2C] hover:text-white hover:border-transparent">ALL</button>
    <button data-filter="pool" class="filter-btn bg-white text-black px-4 py-2 text-xs font-title tracking-widest transition-colors duration-300 border border-black hover:bg-[#916B2C] hover:text-white hover:border-transparent">POOL</button>
    <button data-filter="resort" class="filter-btn bg-white text-black px-4 py-2 text-xs font-title tracking-widest transition-colors duration-300 border border-black hover:bg-[#916B2C] hover:text-white hover:border-transparent">RESORT</button>
    <button data-filter="villa" class="filter-btn bg-white text-black px-4 py-2 text-xs font-title tracking-widest transition-colors duration-300 border border-black hover:bg-[#916B2C] hover:text-white hover:border-transparent">Our VILLAS</button>
    <button data-filter="experience" class="filter-btn bg-white text-black px-4 py-2 text-xs font-title tracking-widest transition-colors duration-300 border border-black hover:bg-[#916B2C] hover:text-white hover:border-transparent">EXPERIENCES</button>
  </div>

  <!-- Gallery Grid -->
  <div id="gallery-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4">
    {galleryItems.map((gallery, i) => {
      const thumb = gallery.image.asset.url;
      const full = thumb.replace('/800/600', '/1600/1200');
      const alt = gallery.imageAlt?.[locale] ?? 'Gallery';

      return (
        <div
          class="gallery-item cursor-pointer group aspect-[4/3] overflow-hidden relative"
          data-category={gallery.category}
          data-full={full}
          key={`gallery-${i}`}
        >
          <OptimizedImage
            src={thumb}
            alt={alt}
            width={800}
            height={600}
            quality={75}
            loading="lazy"
            className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
          />
        </div>
      );
    })}
  </div>

  <!-- Modal -->
  <div id="image-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center">
    <div class="relative max-w-6xl mx-auto">
      <button id="modal-close" class="absolute top-4 right-4 text-white text-2xl z-10">âœ•</button>
      <img id="modal-image" src="" class="max-h-[80vh] mx-auto rounded shadow-xl" />
    </div>
  </div>
</section>



<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const filterButtons = document.querySelectorAll(".filter-btn");
    const items = document.querySelectorAll(".gallery-item");
    const modal = document.getElementById("image-modal");
    const modalImg = document.getElementById("modal-image");
    const modalClose = document.getElementById("modal-close");

    // Filtering
    filterButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const filter = btn.getAttribute("data-filter");
        items.forEach(item => {
          const match = filter === "all" || item.dataset.category === filter;
          item.classList.toggle("hidden", !match);
        });
      });
    });

    // Open Modal
    items.forEach(item => {
      item.addEventListener("click", () => {
        const fullSrc = item.getAttribute("data-full");
        modalImg.src = fullSrc;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      });
    });

    // Close Modal
    modalClose.addEventListener("click", () => {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    });

    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
    });
  });
</script>


</Layout>

---
// Import necessary components and utilities
import Layout from '../../layouts/Base.astro';
import client from '../../lib/sanityClient';
import { getLocale } from '../../utils/getLocale';
import OptimizedImage from '../../components/OptimizedImage.astro';
import { toHTML } from '@portabletext/to-html';

// Generate static paths for supported languages
export async function getStaticPaths() {
  return ['en', 'ko', 'zh'].map(lang => ({ params: { lang } }));
}

// Get language parameter and locale
const { lang } = Astro.params;
const locale = getLocale(lang);

// Helper to ensure array safety
const safeArray = arr => Array.isArray(arr) ? arr : [];

// Fetch page details from Sanity CMS
const pageDetails = await client.fetch(`*[_type == "page" && _id == "3318747c-5991-4285-84c8-daafbcc7b27b"][0]{
  title, subtitle, description, metaTitle, metaDescription, metaKeywords,
  mainImageAlt, mainImage { asset->{url} }
}`);

const servicesDetails = await client.fetch(`*[_type == "settingHome" && _id == "bfb1b55f-9bef-48d8-9507-4c7bf94ee9f6"][0]{ title, richTextDescription }`);
const facilitiesDetails = await client.fetch(`*[_type == "settingHome" && _id == "339ce373-16a6-4124-94d0-15333b2be432"][0]{ title, richTextDescription }`);
const exclusiveDetails = await client.fetch(`*[_type == "settingHome" && _id == "fdb025f3-1ecd-468d-adaa-87b0d96f3292"][0]{ title, richTextDescription }`);

// Prepare content and meta data for the page
const pageDescription = toHTML(safeArray(pageDetails.description?.[locale]));
const servicesDescription = toHTML(safeArray(servicesDetails.richTextDescription?.[locale]));
const facilitiesDescription = toHTML(safeArray(facilitiesDetails.richTextDescription?.[locale]));
const exclusiveDescription = toHTML(safeArray(exclusiveDetails.richTextDescription?.[locale]));
const title = pageDetails?.metaTitle?.[locale] ?? '';
const description = pageDetails?.metaDescription?.[locale] ?? '';
const url = new URL(Astro.request.url).href;
const ogImage = pageDetails.mainImage?.asset?.url ?? '';
const keywords = pageDetails.metaKeywords?.[locale] ?? '';
---

<Layout {title} {description} {url} {ogImage} {keywords}>
  {/* Hero section with background image */}
  <section class="relative w-full h-[50vh] md:h-[60vh] lg:h-[75vh] overflow-hidden">
    <OptimizedImage
      src={pageDetails.mainImage.asset.url}
      alt={pageDetails.mainImageAlt?.[locale] ?? ''}
      width={1600} height={900} quality={75}
      className="w-full h-full object-cover"
    />
    <div class="absolute inset-0 bg-black/25 z-20"></div>
  </section>

  {/* Main content section with title, description, and YouTube video */}
  <section class="container mx-auto px-4 xl:px-10 2xl:px-56 pt-16 md:pt-24">
    <div class="text-center px-2 sm:px-6 md:px-8 mx-auto">
      <h1 class="font-title text-3xl sm:text-4xl md:text-5xl uppercase mb-4 md:mb-6 tracking-widest font-light">
        {pageDetails?.title?.[locale] ?? ''}
      </h1>
      <div class="mb-12 md:mb-18 text-lg" set:html={pageDescription}></div>
    </div>
  </section>

  {/* Accordion */}
  <section class="container mx-auto px-4 xl:px-10 2xl:px-0 pb-12">
    <div class="border-t border-b border-gray-300">
      <button
        type="button"
        class="w-full flex justify-between items-center py-4 font-title text-left text-lg uppercase toggle-btn"
        data-target="accordion-1"
        aria-expanded="false"
        aria-controls="accordion-1"
      >
        {servicesDetails?.title?.[locale] ?? ''}
        {/* SVG icon for accordion toggle */}
        <svg class="w-5 h-5 transition-transform duration-300" data-icon data-target="accordion-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div id="accordion-1" class="grid grid-cols-1 gap-6 pb-6 hidden" role="region" aria-labelledby="accordion-1">
        <div class="text-lg max-w-none" set:html={servicesDescription}></div>
      </div>
    </div>
    <div class="">
      <button
        type="button"
        class="w-full flex justify-between items-center py-4 font-title text-left text-lg uppercase toggle-btn"
        data-target="accordion-2"
        aria-expanded="false"
        aria-controls="accordion-2"
      >
        {facilitiesDetails?.title?.[locale] ?? ''}
        {/* SVG icon for accordion toggle */}
        <svg class="w-5 h-5 transition-transform duration-300" data-icon data-target="accordion-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div id="accordion-2" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6 hidden" role="region" aria-labelledby="accordion-2">
        <div class="text-lg max-w-none" set:html={facilitiesDescription}></div>
      </div>
    </div>
    <div class="border-t border-b border-gray-300">
      <button
        type="button"
        class="w-full flex justify-between items-center py-4 font-title text-left text-lg uppercase toggle-btn"
        data-target="accordion-3"
        aria-expanded="false"
        aria-controls="accordion-3"
      >
        {exclusiveDetails?.title?.[locale] ?? ''}
        {/* SVG icon for accordion toggle */}
        <svg class="w-5 h-5 transition-transform duration-300" data-icon data-target="accordion-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div id="accordion-3" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6 hidden" role="region" aria-labelledby="accordion-3">
        <div class="text-lg max-w-none" set:html={exclusiveDescription}></div>
      </div>
    </div>
  </section>

  {/* Inline script for accordion toggle functionality */}
  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.dataset.target;
          const panel = document.getElementById(targetId);
          const icon = document.querySelector(`svg[data-icon][data-target="${targetId}"]`);
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          btn.setAttribute('aria-expanded', String(!expanded));
          panel.classList.toggle('hidden');
          icon.classList.toggle('rotate-180');
        });
      });
    });
  </script>
</Layout>

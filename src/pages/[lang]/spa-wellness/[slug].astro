---
// Import dependencies and components
import Layout from '../../../layouts/Base.astro';
import client from '../../../lib/sanityClient';
import { getLocale } from '../../../utils/getLocale';
import OptimizedImage from '../../../components/OptimizedImage.astro';
import { toHTML } from '@portabletext/to-html';

// Generate static paths for all wellness experiences and venues in all languages
export async function getStaticPaths() {
  const [experienceSlugs, venueSlugs] = await Promise.all([
    client.fetch(`*[_type == "wellnessExperience" && defined(slug.current)]{ "slug": slug.current }`),
    client.fetch(`*[_type == "wellnessVenue" && defined(slug.current)]{ "slug": slug.current }`)
  ]);
  const allSlugs = [...experienceSlugs, ...venueSlugs];
  const languages = ['en', 'ko', 'zh'];
  return languages.flatMap(lang =>
    allSlugs.map(item => ({
      params: { lang, slug: item.slug }
    }))
  );
}

// Get params and locale
const { lang, slug } = Astro.params;
const locale = getLocale(lang);
const safeArray = arr => Array.isArray(arr) ? arr : [];

// Fetch wellnessExperience or fallback to wellnessVenue by slug
let wellness = await client.fetch(
  `*[_type == "wellnessExperience" && slug.current == $slug][0]{
    _type, title, excerpt, description, mainImage { asset->{url} }, mainImageAlt,
    metaTitle, metaDescription, metaKeywords,
    "details": details[$locale], "contactBooking": contactBooking[$locale],
    packages[]{
      title,
      images[]{asset->{url}},
      price,
      description,
      inclusion
    }
  }`, { slug, locale }
);

if (!wellness) {
  wellness = await client.fetch(
    `*[_type == "wellnessVenue" && slug.current == $slug][0]{
      _type, title, excerpt, description, mainImage { asset->{url} }, mainImageAlt,
      metaTitle, metaDescription, metaKeywords,
      "details": details[$locale], "contactBooking": contactBooking[$locale], "policy": policy[$locale],
      packages[]{
      category,
      categoryDescription,
      title,
      images[]{asset->{url}},
      price,
      description,
      inclusion
    }
    }`, { slug, locale }
  );
}

// Throw error if no document found
if (!wellness) throw new Error(`No document found for slug: ${slug}`);

// Portable Text to HTML options for rendering rich text
const htmlOpts = {
  components: {
    block: ({ children }) => `<p>${children.replace(/\n/g, '<br>')}</p>`,
    list: ({ children, value }) => {
      const type = value?.listItem === 'bullet' || value?.style === 'normal' ? 'bullet' : 'number';
      return type === 'bullet'
        ? `<ul class="list-disc ml-6 space-y-2">${children}</ul>`
        : `<ol class="list-decimal ml-6 space-y-2">${children}</ol>`;
    },
    listItem: ({ children }) => `<li>${children}</li>`,
  }
};

// Convert details and contactBooking to HTML
const detailsHTML = toHTML(safeArray(wellness.details), htmlOpts);
const contactHTML = toHTML(safeArray(wellness.contactBooking), htmlOpts);
const policyHTML = toHTML(safeArray(wellness.policy), htmlOpts);

// Prepare meta and package data
const packages = safeArray(wellness.packages);
const title = wellness?.metaTitle?.[locale] ?? '';
const description = wellness?.metaDescription?.[locale] ?? '';
const baseUrl = new URL(Astro.request.url);
const url = baseUrl.href;
const ogImage = wellness.mainImage?.asset?.url ?? '';
const keywords = wellness.metaKeywords?.[locale] ?? '';
---

<Layout {title} {description} {url} {ogImage} {keywords}>
  {/* Hero section with main image */}
  <section class="relative w-full h-[50vh] md:h-[60vh] lg:h-[75vh] overflow-hidden">
    <OptimizedImage
      src={wellness.mainImage.asset.url}
      alt={wellness.mainImageAlt?.[locale] ?? ''}
      width={1600}
      height={900}
      quality={75}
      className="w-full h-full object-cover"
    />
    <div class="absolute inset-0 bg-black/25 z-20"></div>
  </section>

  {/* Title and description section */}
  <section class="container mx-auto px-4 xl:px-10 2xl:px-0 pt-16 md:pt-24">
    <div class="text-center px-2 sm:px-6 md:px-8 mx-auto">
      <h1 class="font-title text-3xl sm:text-4xl md:text-5xl uppercase mb-4 md:mb-6 tracking-widest font-light">
        {wellness?.title?.[locale] ?? ''}
      </h1>
      <p class="text-lg">
        {wellness?.description?.[locale] ?? ''}
      </p>
    </div>
  </section>

  {/* Details and booking section */}
  <section class="container mx-auto px-4 xl:px-10 2xl:px-0 pt-16 md:pt-24">
    <div class="flex flex-col lg:flex-row justify-between gap-12">
      <div class="lg:w-3/5">
        <h3 class="font-title text-xl md:text-2xl uppercase mb-6">Details</h3>
        <div class="text-lg max-w-none pe-0 2xl:pe-42" set:html={detailsHTML}></div>
      </div>
      <div class="lg:w-2/5 flex flex-col items-start">
        <div>
          <h3 class="font-title text-xl md:text-2xl uppercase mb-6">Reserve your experience</h3>
          <div class="text-lg mb-6" set:html={contactHTML}></div>
          <a
            href={`https://wa.me/+628113984566`}
            class="inline-block px-4 py-3 md:px-4 md:py-2 text-xs font-title tracking-widest border bg-[#916B2C] text-white border-transparent hover:bg-white hover:text-black hover:border-black transition-colors duration-300 text-center"
            target="_blank"
            rel="noopener noreferrer"
          >
            BOOK NOW
          </a>
        </div>
      </div>
    </div>
  </section>

  {/* Treatment packages grouped by category (plain JS) */}
{packages.length > 0 && (() => {
  const groupsMap = new Map();

  for (const pkg of packages) {
    const catName = pkg?.category?.[locale]?.trim() || 'General';
    const catBlocks = pkg?.categoryDescription ? pkg.categoryDescription[locale] : [];
    const catDescHTML = toHTML(safeArray(catBlocks), htmlOpts);

    if (!groupsMap.has(catName)) {
      groupsMap.set(catName, { descriptionHTML: catDescHTML, items: [] });
    }
    groupsMap.get(catName).items.push(pkg);
  }

  const groups = Array.from(groupsMap.entries());

  return (
    <section class="container mx-auto px-4 xl:px-10 2xl:px-0 pt-12">
      {groups.map(([catName, group], gi) => (
        <div key={`group-${gi}`}>
          <h3 class="font-title text-xl md:text-2xl uppercase pt-14">{catName}</h3>
          {group.descriptionHTML?.trim() && (
            <div class="text-lg max-w-none" set:html={group.descriptionHTML}></div>
          )}

          {group.items.map((pkg, i) => {
            const pkgDescription = toHTML(safeArray(pkg?.description?.[locale]), htmlOpts);
            const pkgInclusion  = toHTML(safeArray(pkg?.inclusion?.[locale]), htmlOpts);
            const id = `accordion-${gi}-${i}`;

            return pkg?.title?.[locale]?.trim()
              ? (
                <div class="border-b border-gray-300" key={`package-${gi}-${i}`}>
                  <button
                    type="button"
                    class="w-full flex justify-between items-center py-4 text-left text-lg uppercase toggle-btn cursor-pointer hover:bg-gray-50"
                    data-target={id}
                    aria-expanded="false"
                    aria-controls={id}
                  >
                    <div>
                      <div class="text-sm text-gray-500 uppercase tracking-wide">
                        {pkg?.price?.[locale] ?? ''}
                      </div>
                      <span class="font-title">
                        {pkg?.title?.[locale] ?? `Package ${i + 1}`}
                      </span>
                    </div>

                    <div class="flex items-center gap-4">
                      <svg
                        class="w-5 h-5 transition-transform duration-300"
                        data-icon
                        data-target={id}
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                      </svg>
                      <a
                        href={`https://wa.me/+628113984566`}
                        class="inline-block px-4 py-3 md:px-4 md:py-2 text-xs font-title tracking-widest border hover:bg-[#916B2C] hover:text-white hover:border-transparent bg-white text-black border-black transition-colors duration-300 text-center"
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        BOOK NOW
                      </a>
                    </div>
                  </button>

                  <div
                    id={id}
                    class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6 hidden"
                    role="region"
                    aria-labelledby={id}
                  >
                    {pkgDescription && (
                      <div class="space-y-4">
                        <div class="text-lg max-w-none" set:html={pkgDescription}></div>
                      </div>
                    )}
                    {pkgInclusion && (
                      <div class="text-lg max-w-none" set:html={pkgInclusion}></div>
                    )}
                  </div>
                </div>
              )
              : null;
          })}
        </div>
      ))}
    </section>
  );
})()}


{packages.length > 0 && (() => {
  return (
    <section class="container mx-auto px-4 xl:px-10 2xl:px-0 py-14">
      <div class="border-b border-t border-gray-300">
        <button
          type="button"
          class="w-full flex justify-between items-center py-4 text-left text-lg uppercase toggle-btn cursor-pointer"
          data-target="spa-policy"
          aria-expanded="false"
          aria-controls="spa-policy"
        >
          <span class="font-title">Spa Policy</span>
          <svg class="w-5 h-5 transition-transform duration-300" data-icon data-target="spa-policy" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        <div id="spa-policy" class="gap-6 pb-6 hidden" role="region" aria-labelledby="spa-policy">
          <div class="text-lg max-w-none pe-0 2xl:pe-42" set:html={policyHTML}></div>
        </div>
      </div>
    </section>
  );
})()}


  {/* Accordion toggle script */}
  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.dataset.target;
          const panel = document.getElementById(targetId);
          const icon = document.querySelector(`svg[data-icon][data-target="${targetId}"]`);
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          btn.setAttribute('aria-expanded', String(!expanded));
          panel.classList.toggle('hidden');
          icon.classList.toggle('rotate-180');
        });
      });
    });
  </script>
</Layout>

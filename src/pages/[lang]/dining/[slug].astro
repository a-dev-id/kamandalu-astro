---
// Imports and data fetching
import Layout from '../../../layouts/Base.astro';
import client from '../../../lib/sanityClient';
import { getLocale } from '../../../utils/getLocale';
import OptimizedImage from '../../../components/OptimizedImage.astro';
import { toHTML } from '@portabletext/to-html';

// Generate static paths for each language and slug
export async function getStaticPaths() {
  const slugs = await client.fetch(`*[_type == "diningVenue" && defined(slug.current)]{ "slug": slug.current }`);
  const languages = ['en', 'ko', 'zh'];
  return languages.flatMap(lang => slugs.map(venue => ({ params: { lang, slug: venue.slug } })));
}

// Get params and fetch venue data
const { lang, slug } = Astro.params;
const locale = getLocale(lang);
const safeArray = arr => Array.isArray(arr) ? arr : [];

const venue = await client.fetch(`*[_type == "diningVenue" && slug.current == $slug][0]{
  title, excerpt, description, mainImage { asset->{url} }, mainImageAlt, openingHours, contact, detailsRow1, detailsRow2, metaTitle, metaDescription, metaKeywords, gallery[] { asset->{url} },
}`, { slug });

// Prepare HTML fields for rendering
const htmlFields = {
  openingHours: toHTML(safeArray(venue?.openingHours?.[locale])),
  contact: toHTML(safeArray(venue?.contact?.[locale])),
  detailsRow1: toHTML(safeArray(venue?.detailsRow1?.[locale])),
  detailsRow2: toHTML(safeArray(venue?.detailsRow2?.[locale])),
};

// Meta tags and Open Graph data
const title = venue?.metaTitle?.[locale] ?? '';
const description = venue?.metaDescription?.[locale] ?? '';
const url = new URL(Astro.request.url).href;
const ogImage = venue.mainImage?.asset?.url ?? '';
const keywords = venue.metaKeywords?.[locale] ?? '';
---

<Layout {title} {description} {url} {ogImage} {keywords}>
  {/* Hero section with main image */}
  <section class="relative w-full h-[50vh] md:h-[60vh] lg:h-[75vh] overflow-hidden">
    <OptimizedImage
      src={venue.mainImage.asset.url}
      alt={venue.mainImageAlt?.[locale] ?? ''}
      width={1600}
      height={900}
      quality={75}
      className="w-full h-full object-cover"
    />
    <div class="absolute inset-0 bg-black/25 z-20"></div>
  </section>

  {/* Venue title and description */}
  <section class="container mx-auto px-4 xl:px-10 2xl:px-0 py-16 md:py-24">
    <div class="text-center px-2 sm:px-6 md:px-8 mx-auto">
      <h1 class="font-title text-3xl sm:text-4xl md:text-5xl uppercase mb-4 md:mb-6 tracking-widest font-light">{title}</h1>
      <p class="text-lg">{venue?.description?.[locale] ?? ''}</p>
    </div>
  </section>

  {/* Opening hours and contact info section */}
  <section class="bg-[#FAF7EF] text-black py-12 md:py-16">
    <div class="container mx-auto flex flex-col md:flex-row md:justify-between md:items-start gap-8 md:gap-12 px-4">
      
      {/* Section title */}
      <div class="w-full md:w-1/3">
        <h2 class="font-title text-xl md:text-2xl uppercase tracking-widest mb-4 text-center md:text-left">Opening Hours & Information</h2>
      </div>
  
      {/* Opening hours info */}
      <div class="w-full md:w-1/3 flex items-start gap-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 md:w-14 md:h-14 text-black flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l4 2m-4 8a10 10 0 100-20 10 10 0 000 20z" />
        </svg>
        <div>
          <p class="italic text-lg md:text-xl mb-1">Hours</p>
            <div class="custom-list text-lg" set:html={htmlFields.openingHours} />
        </div>
      </div>
  
      {/* Contact info */}
      <div class="w-full md:w-1/3 flex items-start gap-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 md:w-14 md:h-14 text-black flex-shrink-0" viewBox="0 0 24 24">
          <path d="M6.176 1.322l2.844-1.322 4.041 7.89-2.724 1.341c-.538 1.259 2.159 6.289 3.297 6.372.09-.058 2.671-1.328 2.671-1.328l4.11 7.932s-2.764 1.354-2.854 1.396c-7.862 3.591-19.103-18.258-11.385-22.281zm1.929 1.274l-1.023.504c-5.294 2.762 4.177 21.185 9.648 18.686l.971-.474-2.271-4.383-1.026.5c-3.163 1.547-8.262-8.219-5.055-9.938l1.007-.497-2.251-4.398z"/>
        </svg>
        <div>
          <p class="italic text-lg md:text-xl mb-1">Contact</p>
            <div class="custom-list text-lg" set:html={htmlFields.contact} />
        </div>
      </div>
  
    </div>
  </section>
  
  {/* Accordion for venue details */}
  <section class="container mx-auto px-4 xl:px-10 2xl:px-0 py-16">
    <div class="border-b border-gray-300">
      <button
        type="button"
        class="w-full flex justify-between items-center py-4 font-title text-left text-lg uppercase toggle-btn"
        data-target="accordion-1"
        aria-expanded="false"
        aria-controls="accordion-1"
      >
        Details
        <svg class="w-5 h-5 transition-transform duration-300" data-icon data-target="accordion-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div id="accordion-1" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6 hidden" role="region" aria-labelledby="accordion-1">
        <div>
          <div class="custom-list" set:html={htmlFields.detailsRow1} />
        </div>
        <div>
          <div class="custom-list" set:html={htmlFields.detailsRow2} />
        </div>
      </div>
    </div>
  </section>

  {/* Gallery section title */}
  {(venue.gallery ?? []).some(img => img?.asset?.url) && (
    <>
      <section class="container mx-auto px-4 mt-20">
        <div class="text-center px-2 sm:px-6 md:px-8 mx-auto">
          <h2 class="font-title text-xl sm:text-1xl md:text-2xl uppercase mb-4 md:mb-6 tracking-widest font-light">
            Gallery
          </h2>
        </div>
      </section>

      {/* Gallery slider section */}
      <section class="container mx-auto space-y-18 mt-10">
        <div id="venue-slider" class="splide mb-8 md:mb-12" role="region" aria-label="Venue slider">
          <div class="splide__track">
            <div class="splide__list">
              {(venue.gallery ?? []).filter(image => image?.asset?.url).map((image, i) => (
                <div class="splide__slide transition-transform duration-500 ease-in-out" role="group" aria-roledescription="slide" aria-label={`${i + 1} of ${venue.gallery.length}`}>
                  <div class="bg-white overflow-hidden flex flex-col h-full">
                    <OptimizedImage
                      src={image.asset.url}
                      alt={`${venue.mainImageAlt?.[locale]} - ${i + 1}`}
                      width={800} height={600} quality={75} loading="lazy"
                      className="w-full h-auto aspect-[4/3] md:aspect-[16/9] 2xl:aspect-[4/3] transition duration-500"
                    />
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
        {/* Gallery navigation buttons */}
        <div class="flex items-center gap-4 md:gap-6 mt-4 md:mt-8 justify-start">
          <button aria-label="Previous venue Slide" id="venue-prev" class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="20" viewBox="0 0 48 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="44" y1="12" x2="4" y2="12" /><polyline points="12 20 4 12 12 4" /></svg>
          </button>
          <button aria-label="Next venue Slide" id="venue-next" class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="20" viewBox="0 0 48 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="12" x2="44" y2="12" /><polyline points="36 4 44 12 36 20" /></svg>
          </button>
        </div>
      </section>
    </>
  )}

  {/* Accordion toggle script */}
  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.dataset.target;
          const panel = document.getElementById(targetId);
          const icon = document.querySelector(`svg[data-icon][data-target="${targetId}"]`);
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          btn.setAttribute('aria-expanded', !expanded);
          panel.classList.toggle('hidden');
          icon.classList.toggle('rotate-180');
        });
      });
    });
  </script>

  {/* Custom styles for lists */}
  <style>
    .custom-list ul { list-style-type: disc; padding-left: 1.25rem; }
    .custom-list li { margin-bottom: 0.25rem; }
  </style>

  {/* Splide gallery slider initialization */}
  <script>
    import "@splidejs/splide/css";
    import Splide from "@splidejs/splide";
    [
      {
        id: "#venue-slider", prev: "venue-prev", next: "venue-next",
        options: { type: "slide", perPage: 3, gap: "2rem", speed: 800, easing: "ease-in-out", arrows: false, pagination: false, breakpoints: { 1366: { gap: "2rem"}, 1024: { gap: "2rem", perPage: 2 }, 768: { perPage: 1, gap: "2rem" }, 640: { perPage: 1 } } }
      },
    ].forEach(({ id, prev, next, options }) => {
      const splide = new Splide(id, options);
      splide.on('mounted move', () => {
        const prevBtn = document.getElementById(prev), nextBtn = document.getElementById(next);
        prevBtn.disabled = splide.index === 0;
        prevBtn.classList.toggle('opacity-30', splide.index === 0);
        prevBtn.classList.toggle('cursor-not-allowed', splide.index === 0);
        nextBtn.disabled = splide.index >= splide.length - splide.options.perPage;
        nextBtn.classList.toggle('opacity-30', splide.index >= splide.length - splide.options.perPage);
        nextBtn.classList.toggle('cursor-not-allowed', splide.index >= splide.length - splide.options.perPage);
      });
      splide.mount();
      document.getElementById(prev).onclick = () => splide.go("<");
      document.getElementById(next).onclick = () => splide.go(">");
    });
  </script>
</Layout>

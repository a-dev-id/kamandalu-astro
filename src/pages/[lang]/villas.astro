---
import Layout from '../../layouts/Base.astro';
import client from '../../lib/sanityClient';
import { getLocale } from '../../utils/getLocale';
import OptimizedImage from '../../components/OptimizedImage.astro';
import { toHTML } from '@portabletext/to-html';

// Generate static paths for each language
export async function getStaticPaths() {
  return ['en', 'ko', 'zh'].map(lang => ({ params: { lang } }));
}

// Get language from params and locale helper
const { lang } = Astro.params;
const locale = getLocale(lang);

// Helper to ensure array safety
const safeArray = arr => Array.isArray(arr) ? arr : [];

// Fetch page details from Sanity CMS
const pageDetails = await client.fetch(`*[_type == "page" && _id == "3e09def0-f5fd-4b6a-b749-8757187239e9"][0]{
  title, subtitle, description, metaTitle, metaDescription, metaKeywords, mainImageAlt,
  mainImage { asset->{url} }
}`);

// Fetch all villas from Sanity CMS
const villas = await client.fetch(`*[_type == "villa"] | order(order asc){
  "slug": slug.current, title, excerpt, villaSize, bedSize, view,
  secondImage { asset->{url} }, secondImageAlt
}`);

// Prepare meta and description data
const pageDescription = toHTML(safeArray(pageDetails.description?.[locale]));
const title = pageDetails?.metaTitle?.[locale] ?? '';
const description = pageDetails?.metaDescription?.[locale] ?? '';
const url = new URL(Astro.request.url).href;
const ogImage = pageDetails.mainImage?.asset?.url ?? '';
const keywords = pageDetails.metaKeywords?.[locale] ?? '';
---

<Layout {title} {description} {url} {ogImage} {keywords}>
  {/* Hero section with main image */}
  <section class="relative w-full h-[50vh] md:h-[60vh] lg:h-[75vh] overflow-hidden">
    <OptimizedImage
      src={pageDetails.mainImage?.asset?.url}
      alt={pageDetails.mainImageAlt?.[locale] ?? ''}
      width={1600}
      height={900}
      quality={75}
      className="w-full h-full object-cover"
    />
    <div class="absolute inset-0 bg-black/25 z-20"></div>
  </section>

  {/* Page title and description */}
  <section class="container mx-auto px-4 py-16 md:py-24">
    <div class="text-center px-2 sm:px-6 md:px-8 mx-auto">
      <h1 class="font-title text-3xl sm:text-4xl md:text-5xl uppercase mb-4 md:mb-6 tracking-widest font-light">
        {pageDetails?.title?.[locale] ?? ''}
      </h1>
      <div class="text-lg" set:html={pageDescription}></div>
    </div>
  </section>

  {/* Villas listing section */}
  <section class="container mx-auto px-4 space-y-18">
    {villas.map(villa => (
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 items-center">
        {/* Villa image */}
        <div class="relative">
          <OptimizedImage
            src={villa.secondImage.asset.url}
            alt={villa.secondImageAlt?.[locale] ?? ''}
            width={800}
            height={600}
            quality={75}
            className="w-full h-auto object-cover aspect-[16/9] transition duration-500"
          />
        </div>
        {/* Villa details */}
        <div class="flex flex-col justify-center px-2">
          <h2 class="text-2xl md:text-3xl font-title tracking-wide uppercase mb-4">
            {villa.title?.[locale] ?? ''}
          </h2>
          <p class="mb-6 text-lg">
            {villa.excerpt?.[locale] ?? ''}
          </p>
          {/* Villa features: size, bed, view */}
          <div class="flex flex-wrap gap-8 text-sm text-[#1C2A39] mb-8">
            <div class="flex items-center gap-2">
              <img src="/images/villas/area.png" alt="Room size" class="w-5 h-5" loading="lazy" />
              <span>{villa.villaSize?.[locale] ?? ''}</span>
            </div>
            <div class="flex items-center gap-2">
              <img src="/images/villas/bed.png" alt="Bed type" class="w-5 h-5" loading="lazy" />
              <span>{villa.bedSize?.[locale] ?? ''}</span>
            </div>
            <div class="flex items-center gap-2">
              <img src="/images/villas/interface.png" alt="View" class="w-5 h-5" loading="lazy" />
              <span>{villa.view?.[locale] ?? ''}</span>
            </div>
          </div>
          {/* Action buttons: Book Now and Details */}
          <div class="flex gap-4">
            <a
              href="https://www.book-secure.com/index.php?s=results&property=idbal31692&locale=en_GB&currency=IDR&stid=986w12cwy"
              class="bg-[#916B2C] border border-[#916B2C] uppercase text-white px-4 py-3 md:px-6 md:py-4 text-xs md:text-sm font-title tracking-widest transition-colors duration-300 hover:border hover:border-gray-700 hover:bg-white hover:text-gray-700 inline-block"
            >Book Now</a>
            <a
              href={`/${lang}/villa/${villa.slug}`}
              class="bg-white uppercase text-gray-700 px-4 py-3 md:px-6 md:py-4 text-xs md:text-sm font-title tracking-widest transition-colors duration-300 border border-gray-700 hover:bg-[#916B2C] hover:text-white hover:border-transparent inline-block"
            >Details</a>
          </div>
        </div>
      </div>
    ))}
  </section>
</Layout>

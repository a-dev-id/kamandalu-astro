---
import Layout from '../../layouts/Base.astro';
import client from '../../lib/sanityClient';
import { getLocale } from '../../utils/getLocale';
import OptimizedImage from '../../components/OptimizedImage.astro';
import { toHTML } from '@portabletext/to-html';

// Generate static paths for each language
export async function getStaticPaths() {
  return ['en', 'ko', 'zh'].map(lang => ({ params: { lang } }));
}

// Get current language and locale
const { lang } = Astro.params;
const locale = getLocale(lang);

// Helper to ensure array
const safeArray = arr => Array.isArray(arr) ? arr : [];

// Fetch main page details from Sanity
const pageDetails = await client.fetch(`*[_type == "page" && _id == "89c9b6c7-8a83-4d98-92d7-775acb1d9b1c"][0]{
  title, subtitle, description, metaTitle, metaDescription, metaKeywords, mainImageAlt,
  mainImage { asset->{url} }
}`);

// Fetch wellness section details
const wellness = await client.fetch(`*[_type == "settingHome" && _id == "33910d6e-0de3-49b2-bb23-354b1da3e9cc"][0]{
  title, subtitle, description,
}`);

// Fetch wellness experiences for carousel
const wellnessExperiences = await client.fetch(`*[_type == "wellnessExperience"] | order(order asc){
  "slug": slug.current, title, excerpt, secondImage { asset->{url} }, secondImageAlt
}`);

// Fetch venues for venue carousel
const venues = await client.fetch(`*[_type == "wellnessVenue"] | order(order asc){
  "slug": slug.current, title, excerpt, secondImage { asset->{url} }, secondImageAlt
}`);

// Prepare meta and page data
const pageDescription = toHTML(safeArray(pageDetails.description?.[locale]));
const title = pageDetails?.metaTitle?.[locale] ?? '';
const description = pageDetails?.metaDescription?.[locale] ?? '';
const url = new URL(Astro.request.url).href;
const ogImage = pageDetails.mainImage?.asset?.url ?? '';
const keywords = pageDetails.metaKeywords?.[locale] ?? '';
---

<Layout {title} {description} {url} {ogImage} {keywords}>
  {/* Hero section with main image */}
  <section class="relative w-full h-[50vh] md:h-[60vh] lg:h-[75vh] overflow-hidden">
    <OptimizedImage
      src={pageDetails.mainImage?.asset?.url}
      alt={pageDetails.mainImageAlt?.[locale] ?? ''}
      width={1600} height={900} quality={75}
      className="w-full h-full object-cover"
    />
    <div class="absolute inset-0 bg-black/25 z-20"></div>
  </section>

  {/* Page title and description */}
  <section class="container mx-auto px-4 py-16 md:py-24">
    <div class="text-center px-2 sm:px-6 md:px-8 mx-auto">
      <h1 class="font-title text-3xl sm:text-4xl md:text-5xl uppercase mb-4 md:mb-6 tracking-widest font-light">
        {pageDetails?.title?.[locale] ?? ''}
      </h1>
      <div class="mb-12 md:mb-18 text-lg" set:html={pageDescription}></div>
    </div>
  </section>

  {/* Venue carousel section */}
  <section class="container mx-auto px-4 space-y-18">
    <div id="venue-carousel" class="splide mb-8 md:mb-12" role="region" aria-label="Venue Carousel">
      <div class="splide__track">
        <div class="splide__list">
          {venues.map((data, i) => (
            <div class="splide__slide transition-transform duration-500 ease-in-out" role="group" aria-roledescription="slide" aria-label={`${i + 1} of ${venues.length}`}>
              <div class="bg-white overflow-hidden flex flex-col h-full">
                <OptimizedImage
                  src={data.secondImage.asset.url}
                  alt={data.secondImageAlt?.[locale]}
                  width={800} height={600} quality={75} loading="lazy"
                  className="w-full h-auto aspect-[4/3] md:aspect-[16/9] 2xl:aspect-[4/3] transition duration-500"
                />
                <div class="py-4 md:py-6 flex flex-col flex-1">
                  <h3 class="text-lg tracking-widest uppercase font-title">{data?.title?.[locale] ?? ''}</h3>
                  <p class="mt-2 text-lg">{/*data?.excerpt?.[locale] ?? ''*/}</p>
                  <div class="flex-grow"></div>
                  <a href={`/${locale}/spa-wellness/${data.slug}`} class="text-lg mt-4 inline-block text-gray-700 uppercase">Details</a>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
    {/* Venue carousel navigation buttons (mobile) */}
    <div class="flex items-center gap-4 md:gap-6 mt-4 md:mt-8 justify-center md:hidden">
      <button aria-label="Previous venue Slide" id="venue-prev" class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center">
        {/* Left arrow SVG */}
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="20" viewBox="0 0 48 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="44" y1="12" x2="4" y2="12" /><polyline points="12 20 4 12 12 4" /></svg>
      </button>
      <button aria-label="Next venue Slide" id="venue-next" class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center">
        {/* Right arrow SVG */}
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="20" viewBox="0 0 48 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="12" x2="44" y2="12" /><polyline points="36 4 44 12 36 20" /></svg>
      </button>
    </div>
  </section>

  {/* Wellness experiences carousel section */}
  <section class="container mx-auto px-4 xl:px-10 2xl:px-0 pt-24">
    <div class="text-center px-2 sm:px-6 md:px-8 mx-auto">
      <h2 class="font-title text-2xl md:text-3xl uppercase mb-4 md:mb-6 tracking-widest font-light">{wellness?.title?.[locale] ?? ''}</h2>
      <p class="mb-10 md:mb-20 text-lg">{wellness?.description?.[locale] ?? ''}</p>
    </div>
    <div id="wellness-carousel" class="splide mb-8 md:mb-12" role="region" aria-label="Wellness Carousel">
      <div class="splide__track">
        <div class="splide__list">
          {wellnessExperiences.map((data, i) => (
            <div class="splide__slide transition-transform duration-500 ease-in-out" role="group" aria-roledescription="slide" aria-label={`${i + 1} of ${wellnessExperiences.length}`}>
              <div class="bg-white overflow-hidden flex flex-col h-full">
                <OptimizedImage
                  src={data.secondImage.asset.url}
                  alt={data.secondImageAlt?.[locale]}
                  width={800} height={600} quality={75} loading="lazy"
                  className="w-full h-auto aspect-[4/3] transition duration-500"
                />
                <div class="py-4 md:py-6 flex flex-col flex-1">
                  <h3 class="text-lg tracking-widest uppercase font-title">{data.title?.[locale] ?? data.title?.en}</h3>
                  <p class="mt-2 text-lg">{/*data.excerpt?.[locale] ?? data.excerpt?.en*/}</p>
                  <div class="flex-grow"></div>
                  <a href={`/${locale}/spa-wellness/${data.slug}`} class="text-lg mt-4 inline-block text-gray-700 uppercase">Details</a>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
    {/* Wellness carousel navigation buttons */}
    <div class="flex items-center gap-4 md:gap-6 mt-4 md:mt-8 justify-start">
      <button aria-label="Previous wellness slide" id="wellness-prev" class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center">
        {/* Left arrow SVG */}
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="20" viewBox="0 0 48 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="44" y1="12" x2="4" y2="12" /><polyline points="12 20 4 12 12 4" /></svg>
      </button>
      <button aria-label="Next wellness slide" id="wellness-next" class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center">
        {/* Right arrow SVG */}
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="20" viewBox="0 0 48 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="12" x2="44" y2="12" /><polyline points="36 4 44 12 36 20" /></svg>
      </button>
    </div>
  </section>

  {/* Splide carousel initialization script */}
  <script>
    import "@splidejs/splide/css";
    import Splide from "@splidejs/splide";
    [
      {
        id: "#venue-carousel", prev: "venue-prev", next: "venue-next",
        options: { type: "slide", perPage: 2, gap: "4rem", speed: 800, easing: "ease-in-out", arrows: false, pagination: false, breakpoints: { 1366: { gap: "2rem"}, 1024: { gap: "2rem", perPage: 2 }, 768: { perPage: 1, gap: "2rem" }, 640: { perPage: 1 } } }
      },
      {
        id: "#wellness-carousel", prev: "wellness-prev", next: "wellness-next",
        options: { type: "slide", perPage: 3, gap: "4rem", speed: 800, easing: "ease-in-out", arrows: false, pagination: false, breakpoints: { 1366: { gap: "2rem"}, 1024: { gap: "2rem", perPage: 2 }, 768: { perPage: 1, gap: "2rem" }, 640: { perPage: 1 } } }
      }
    ].forEach(({ id, prev, next, options }) => {
      const splide = new Splide(id, options);
      splide.on('mounted move', () => {
        const prevBtn = document.getElementById(prev), nextBtn = document.getElementById(next);
        prevBtn.disabled = splide.index === 0;
        prevBtn.classList.toggle('opacity-30', splide.index === 0);
        prevBtn.classList.toggle('cursor-not-allowed', splide.index === 0);
        nextBtn.disabled = splide.index >= splide.length - splide.options.perPage;
        nextBtn.classList.toggle('opacity-30', splide.index >= splide.length - splide.options.perPage);
        nextBtn.classList.toggle('cursor-not-allowed', splide.index >= splide.length - splide.options.perPage);
      });
      splide.mount();
      document.getElementById(prev).onclick = () => splide.go("<");
      document.getElementById(next).onclick = () => splide.go(">");
    });
  </script>
</Layout>
